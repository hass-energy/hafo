name: Release

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  validate-release:
    name: Validate release version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Install uv
        uses: astral-sh/setup-uv@681c641aba71e4a1c380be3ab5e12ad51f415867 # v7.1.6

      - name: Extract and validate version from release tag
        run: |
          TAG="${{ github.event.release.tag_name }}"
          VERSION="${TAG#v}"
          echo "Tag: $TAG"
          echo "Version: $VERSION"

          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Release tag '$TAG' does not match semantic versioning format (vX.Y.Z)"
            exit 1
          fi

      - name: Check pyproject.toml version matches tag
        run: |
          TAG="${{ github.event.release.tag_name }}"
          TAG_VERSION="${TAG#v}"
          PYPROJECT_VERSION=$(uv run python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")
          echo "Tag version: $TAG_VERSION"
          echo "pyproject.toml version: $PYPROJECT_VERSION"
          if [[ "$TAG_VERSION" != "$PYPROJECT_VERSION" ]]; then
            echo "::error::Tag version ($TAG_VERSION) does not match pyproject.toml version ($PYPROJECT_VERSION)"
            exit 1
          fi

      - name: Check manifest.json version matches tag
        run: |
          TAG="${{ github.event.release.tag_name }}"
          TAG_VERSION="${TAG#v}"
          MANIFEST_VERSION=$(jq -r '.version' custom_components/hafo/manifest.json)
          echo "Tag version: $TAG_VERSION"
          echo "manifest.json version: $MANIFEST_VERSION"
          if [[ "$TAG_VERSION" != "$MANIFEST_VERSION" ]]; then
            echo "::error::Tag version ($TAG_VERSION) does not match manifest.json version ($MANIFEST_VERSION)"
            exit 1
          fi

  upload-assets:
    name: Upload release assets
    needs: validate-release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Create release package
        run: |
          cd custom_components
          zip -r ../hafo.zip hafo

      - name: Upload release assets
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          files: |
            hafo.zip
